<script>

var script = getScript();
var arDetectedFunctions = [];

parse();
console.log(arDetectedFunctions);


function parse()
{
    arDetectedFunctions = getFunctions(script);
}


function getFunctions(script)
{
    if (!script)
        return [];
    
    var arLines = script.split("\n");
    
    var ar = [];
    var inComment = 0;
    var inFunction = 0;

    for(var line of arLines)
    {
        line = line.trimStart();

        if (line.startsWith("//"))
            continue;
        
        // ... needs update to better handle multi-line comments
        if (line.indexOf("/*") >= 0)
            inComment++;
        
        if (line.indexOf("*/") >= 0 && inComment >= 0)
            inComment--;

        if (inComment === 0 && inFunction === 0 && line.startsWith("function"))
        {
            var fn = getFunction(line);
            ar.push(fn);
        }

        if (!inComment)
        {
            if (line.indexOf("{") >= 0)
                inFunction++;

            if (line.indexOf("}") >= 0 && inFunction >= 0)
                inFunction--;
        }
    }

    return ar;
}

function getFunction(line)
{
    var keyword = "function";

    var i1 = keyword.length;
    var i2 = line.indexOf("(", i1);

    if (i1 >= line.length || i1 >= i2)
        return null;

    var fn = line.substr(i1, i2 - i1);

    return fn.trim();
}


function getScript() { return `// #SKETCHNAME Blocky
const squareSize = 16;
const noRows = 30;
const noCols = 50;

displayGridPaper();

function loop() 
{
    function test()
    {

    }

    // Call to displayCell at mouse coordinates, only if mouse is pressed
    if (mouseIsPressed)
    {
        var color = mouseButton == LEFT ? "Black" : "White";
        displayCell(mouseX, mouseY, color);
    }
}

// Display the cell that contains the point (x, y)
function displayCell(x, y, color)
{
    var col = floor( x / squareSize );
    var row = floor( y / squareSize );

    if (col >= noCols || row >= noRows)
        return;

    // determine the cell left upper-corner x and y coordinates
    var cellX = col * squareSize;
    var cellY = row * squareSize;

    fill(color);
    rect(cellX, cellY, squareSize, squareSize);
}

// Display the grid paper using a series of white rectangles
function displayGridPaper()
{
    for(var row = 0; row < noRows; row++)
    {
        for(var col = 0; col < noCols; col++)
        {
            var x = col * squareSize;
            var y = row * squareSize;

            rect(x, y, squareSize, squareSize);
        }
    }
}
`}
    
</script>
