<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> -->
    <title>CodeBeanz Playground</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-storage.js"></script>
    
    <script src="editor/HtmlUtils.js"></script>
    <script src="firebase/FirebaseDB.js"></script>
</head>
<body>

<div style='display: flex; width: 100%; justify-content: flex-end;'>
    <span id="btnLogIn" style='cursor: pointer; margin:10px;display:none;'>Log in</span>
    <span id="btnSignUp" style='cursor: pointer; margin:10px;display:none;'>Sign up</span>
    <span id="btnLogOut" style='cursor: pointer; margin:10px;display: none;'>Log out</span>
    <br>
    <span id="lblUser" style='font-weight: bold; margin:10px;display: none;'>User</span>
</div>

<div id="divSignIn" style='background-color: lightblue;display:none;'>
    <h2>Sign-In</h2>

    User:<br>
    <input id="txtUser" value="myuser">
    <br><br>
    Password:<br>
    <input id="txtPassword" value="mypassword">
    
    <br><br>
    
    <button id="btnSignInOK">Sign In</button>
    <button id="btnSignInCancel">Cancel</button>
</div>

<div id="divSignUp" style='background-color: lightgreen;display:none;'>
    <h2>Sign-Up</h2>
    User:<br>
    <input id="txtSignUpUser" value="myuser">
    <br><br>
    Password:<br>
    <input id="txtSignUpPassword" value="mypassword">
    <br><br>
    Parent email:<br>
    <input id="txtParentEmail" value="mveteanu@gmail.com">
    <br><br>
    Student email (if older > 13):<br>
    <input id="txtStudentEmail" value="">

    <br><br>

    <button id="btnSignUpOK">Sign Up</button>
    <button id="btnSignUpCancel">Cancel</button>
</div>

<h1>New</h1>
<ul>
    <li><a href="code.html">New Playground</a></li>
</ul>

<h1>Code on Web</h1>
<ul>
    <li><a href="code.html?1">Example 1</a></li>
    <br>
    <li><a href="code.html?2">Example 2</a></li>
    <br>
    <li><a href="code.html?3">Example 3</a></li>
</ul>


<h1>My code</h1>
<ul id="lstMyCode">
</ul>


<h1>Other code</h1>
<ul>
    <li><a href="code.html?UBhKw7J2QdoosC2IBwq4">myuserx: UBhKw7J2QdoosC2IBwq4</a></li>
    <br>
    <li><a href="code.html?Xgwig8rYc0gOHuYmd5cE">myuserx: Xgwig8rYc0gOHuYmd5cE</a></li>
</ul>


<h1>Tutorials</h1>

<li><a href="code.html?t=1">Tutorial 1</a></li>
<br>
<li><a href="code.html?t=2">Tutorial 2</a></li>


<script>
var db = FirebaseDB(HandleAuthChanged);
var userActive = false;

window.onload = function()
{
    btnLogIn.addEventListener("click", HandleBtnLoginClick);
    btnSignUp.addEventListener("click", HandleBtnSignUpClick);
    btnLogOut.addEventListener("click", HandleBtnLogOutClick);

    btnSignInOK.addEventListener("click", HandleBtnSignInOKClick);
    btnSignUpOK.addEventListener("click", HandleBtnSignUpOKClick);

    btnSignInCancel.addEventListener("click", HandleBtnSignInUpCancelClick);
    btnSignUpCancel.addEventListener("click", HandleBtnSignInUpCancelClick);
}

function HandleAuthChanged(user)
{
    if (user)
    {
        btnLogIn.style.display = "none";
        btnSignUp.style.display = "none";
        btnLogOut.style.display = "inline";

        lblUser.style.display = "inline";
        lblUser.innerText = db.getAccountName(user);
        lblUser.style.color = "";

        db.getStudentDetails().then(function(userData) {
            userActive = userData && userData.active;
            lblUser.style.color = userActive ? "" : "red";
        });

        generateMyCodeList("lstMyCode");
    }
    else
    {
        btnLogIn.style.display = "inline";
        btnSignUp.style.display = "inline";
        btnLogOut.style.display = "none";

        lblUser.style.display = "none";
    }
}


function HandleBtnLoginClick(e)
{
    divSignUp.style.display = 'none'
    divSignIn.style.display = 'block';
}

function HandleBtnSignUpClick(e)
{
    divSignIn.style.display = 'none';
    divSignUp.style.display = 'block'
}

function HandleBtnSignInUpCancelClick(e)
{
    divSignIn.style.display = 'none';
    divSignUp.style.display = 'none'
}

async function HandleBtnSignInOKClick(e)
{
    try
    {
        var txtUser = document.getElementById("txtUser");
        var txtPassword = document.getElementById("txtPassword");

        await db.signInStudent(txtUser.value, txtPassword.value);
        HandleBtnSignInUpCancelClick(e);
    }
    catch(error)
    {
        var errorCode = error.code;
        var errorMessage = error.message;
        alert(errorMessage);
    }
}

async function HandleBtnSignUpOKClick(e)
{
    try
    {    
        var txtUser = document.getElementById("txtSignUpUser");
        var txtPassword = document.getElementById("txtSignUpPassword");

        var txtParentEmail = document.getElementById("txtParentEmail");
        var txtStudentEmail = document.getElementById("txtStudentEmail");

        await db.createStudentAccount(txtUser.value, txtPassword.value, { parentEmail : txtParentEmail.value, studentEmail : txtStudentEmail.value });
        HandleBtnSignInUpCancelClick(e);
    }
    catch(error)
    {
        var errorCode = error.code;
        var errorMessage = error.message;

        if (errorCode == "auth/email-already-in-use")
            errorMessage = "User already exists!"

        alert(errorMessage);
    }
}

async function HandleBtnLogOutClick(e)
{
    await db.signOut();
}

async function generateMyCodeList(lstName)
{
    var html = HtmlUtils();
    var htmlLst = document.getElementById(lstName);

    var lst = await db.getMyFiles();

    for(var file of lst)
    {
        var d = new Date(file.creationDate);
        var txt = `<a href="code.html?${file.id}">${file.name} - ${d.toDateString() + " " + d.toLocaleTimeString()}</a><br>`;

        html.appendElement(txt, htmlLst);
    }
}

</script>

</body>

</html>
